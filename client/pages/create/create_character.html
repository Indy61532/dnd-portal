<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeroVault - Create Character</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/create_character.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bahiana&family=Cinzel:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="content">
        <div class="navbar main-header">
            <div class="nav-content">
                <a href="../../index.html">
                    <div class="nav-left">
                        <i class="fas logo fa-dragon"></i>
                        <span class="brand">HeroVault</span>
                    </div>
                </a>
                <div class="nav-center create-navbar">
                    <div class="cteate-title">Character Builder</div>
                </div>
                <div class="nav-right profile">
                    <div class="profileimg"></div>
                    <div class="profilename">Adventure Master</div>
                </div>
            </div>
        </div>

        <div class="main wizard-container">
            <!-- Stepper Header -->
            <div class="stepper-header">
                <ul class="wizard-steps">
                    <li class="wizard-step active" data-step="1">
                        <div class="step-indicator">1</div>
                        <span class="step-label">Race</span>
                    </li>
                    <li class="wizard-step" data-step="2">
                        <div class="step-indicator">2</div>
                        <span class="step-label">Class</span>
                    </li>
                    <li class="wizard-step" data-step="3">
                        <div class="step-indicator">3</div>
                        <span class="step-label">Background</span>
                    </li>
                    <li class="wizard-step" data-step="4">
                        <div class="step-indicator">4</div>
                        <span class="step-label">Abilities</span>
                    </li>
                    <li class="wizard-step" data-step="5">
                        <div class="step-indicator">5</div>
                        <span class="step-label">Equipment</span>
                    </li>
                    <li class="wizard-step" data-step="6">
                        <div class="step-indicator">6</div>
                        <span class="step-label">Review</span>
                    </li>
                </ul>
            </div>

            <div class="wizard-content-wrapper">
                <!-- Main Content Area -->
                <div class="wizard-main">
                    
                    <div class="wizard-scroll-area">
                    <!-- Step 1: Race -->
                    <section class="wizard-panel active" id="panel-race">
                        <div class="panel-header">
                            <h2>Choose Race</h2>
                            <p>Select your character's race to determine their fundamental traits.</p>
                        </div>
                        <div class="panel-content">
                            <!-- Placeholder for Race Selection -->
                            <div class="selection-grid">
                                <div class="selection-card">
                                    <div class="card-image-wrapper">
                                        <div class="card-image-placeholder"><i class="fas fa-user"></i></div>
                                    </div>
                                    <div class="card-content">
                                        <h3>Human</h3>
                                    </div>
                                </div>
                                <div class="selection-card">
                                    <div class="card-image-wrapper">
                                        <div class="card-image-placeholder"><i class="fas fa-leaf"></i></div>
                                    </div>
                                    <div class="card-content">
                                        <h3>Elf</h3>
                                    </div>
                                </div>
                                <div class="selection-card">
                                    <!-- Example without image wrapper -->
                                    <div class="card-content">
                                        <h3>Dwarf</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Step 2: Class -->
                    <section class="wizard-panel" id="panel-class">
                        <div class="panel-header">
                            <h2>Choose Class</h2>
                            <p>Select a class to define your character's vocation and special talents.</p>
                        </div>
                        <div class="panel-content">
                            <!-- Placeholder for Class Selection -->
                            <div class="selection-grid">
                                <div class="selection-card centered-card">
                                    <h3>Fighter</h3>
                                </div>
                                <div class="selection-card centered-card">
                                    <h3>Wizard</h3>
                                </div>
                                <div class="selection-card centered-card">
                                    <h3>Rogue</h3>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Step 3: Background -->
                    <section class="wizard-panel" id="panel-background">
                        <div class="panel-header">
                            <h2>Choose Background</h2>
                            <p>Select a background to define your character's history and upbringing.</p>
                        </div>
                        <div class="panel-content">
                            <!-- Placeholder for Background Selection -->
                            <div class="selection-grid">
                                <div class="selection-card centered-card">
                                    <h3>Acolyte</h3>
                                </div>
                                <div class="selection-card centered-card">
                                    <h3>Criminal</h3>
                                </div>
                                <div class="selection-card centered-card">
                                    <h3>Soldier</h3>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Step 4: Ability Scores -->
                    <section class="wizard-panel" id="panel-abilities">
                        <div class="panel-header">
                            <h2>Ability Scores</h2>
                            <p>Determine your character's physical and mental capabilities.</p>
                        </div>
                        <div class="panel-content">
                            
                            <!-- Mode Selector -->
                            <div class="abilities-top-bar">
                                <div class="generation-method">
                                    <label>Generation Method</label>
                                    <select id="ability-method-select" class="method-select">
                                        <option value="point-buy">Point Buy</option>
                                        <option value="standard-array">Standard Array</option>
                                        <option value="manual">Manual / Rolled</option>
                                    </select>
                                </div>
                                <div class="points-display" id="points-container">
                                    <span class="points-label">Points Remaining</span>
                                    <span class="points-value" id="points-remaining">27</span>
                                </div>
                            </div>

                            <!-- Quick Overview -->
                            <div class="abilities-quick-grid">
                                <div class="ability-quick-col">
                                    <div class="ability-name">STR</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="str"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                                <div class="ability-quick-col">
                                    <div class="ability-name">DEX</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="dex"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                                <div class="ability-quick-col">
                                    <div class="ability-name">CON</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="con"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                                <div class="ability-quick-col">
                                    <div class="ability-name">INT</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="int"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                                <div class="ability-quick-col">
                                    <div class="ability-name">WIS</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="wis"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                                <div class="ability-quick-col">
                                    <div class="ability-name">CHA</div>
                                    <div class="ability-base-input"><input type="number" value="8" class="base-score-input" data-ability="cha"></div>
                                    <div class="ability-total-display">
                                        <div class="total-score">8</div>
                                        <div class="total-mod">(-1)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Calculations -->
                            <h3 class="details-header">Score Calculations</h3>
                            <div class="abilities-details-grid">
                                <!-- STR Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-fist-raised"></i></div>
                                        <div class="detail-title">Strength</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                                <!-- DEX Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-running"></i></div>
                                        <div class="detail-title">Dexterity</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                                <!-- CON Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-heartbeat"></i></div>
                                        <div class="detail-title">Constitution</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                                <!-- INT Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-brain"></i></div>
                                        <div class="detail-title">Intelligence</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                                <!-- WIS Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-eye"></i></div>
                                        <div class="detail-title">Wisdom</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                                <!-- CHA Card -->
                                <div class="ability-detail-card">
                                    <div class="detail-header">
                                        <div class="detail-icon"><i class="fas fa-comments"></i></div>
                                        <div class="detail-title">Charisma</div>
                                        <div class="detail-final">
                                            <span class="final-score">8</span>
                                            <span class="final-mod">(-1)</span>
                                        </div>
                                    </div>
                                    <div class="detail-rows">
                                        <div class="detail-row"><span>Base Score</span> <span>8</span></div>
                                        <div class="detail-row"><span>Racial Bonus</span> <span>+0</span></div>
                                        <div class="detail-row"><span>Other Mod</span> <input type="number" class="mini-input" value="0"></div>
                                        <div class="detail-row override"><span>Override</span> <input type="number" class="mini-input override-input" placeholder="-"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- Step 5: Equipment -->
                    <section class="wizard-panel" id="panel-equipment">
                        <div class="panel-header">
                            <h2>Equipment</h2>
                            <p>Choose your starting equipment and weapons.</p>
                        </div>
                        <div class="panel-content">
                            <div class="equipment-layout">
                                <!-- Left Column: Current Inventory -->
                                <div class="current-inventory-section">
                                    <h3>Current Inventory</h3>
                                    <div class="inventory-list" id="inventory-list">
                                        <!-- Placeholder items will go here -->
                                        <div class="empty-state">No items equipped</div>
                                    </div>
                                    <div class="inventory-footer">
                                        Total Weight: <span id="total-weight">0</span> lb.
                                    </div>
                                </div>

                                <!-- Right Column: Add Items -->
                                <div class="add-items-section">
                                    <h3>Add Items</h3>
                                    
                                    <div class="items-controls">
                                        <div class="search-wrapper">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="text" placeholder="Search equipment..." class="item-search-input">
                                        </div>
                                        
                                        <div class="filter-buttons">
                                            <button class="filter-btn active" data-filter="all">All</button>
                                            <button class="filter-btn" data-filter="armor"><i class="fas fa-shield-alt"></i> Armor</button>
                                            <button class="filter-btn" data-filter="weapon"><i class="fas fa-sword"></i> Weapon</button>
                                            <button class="filter-btn" data-filter="potion"><i class="fas fa-flask"></i> Potion</button>
                                            <button class="filter-btn" data-filter="scroll"><i class="fas fa-scroll"></i> Scroll</button>
                                            <button class="filter-btn" data-filter="tool"><i class="fas fa-tools"></i> Tool</button>
                                        </div>
                                    </div>

                                    <div class="items-results-list">
                                        <!-- Results will appear here -->
                                        <div class="item-result-placeholder">
                                            Search for items to add to your inventory
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Step 6: Review -->
                    <section class="wizard-panel" id="panel-review">
                        <div class="panel-header">
                            <h2>Review Character</h2>
                            <p>Finalize your character details before creation.</p>
                        </div>
                        <div class="panel-content">
                            <div class="review-grid">
                                <!-- Character Info -->
                                <div class="review-section info-section">
                                    <h3>Character Details</h3>
                                    <div class="form-group">
                                        <label for="char-name">Character Name</label>
                                        <input type="text" id="char-name" placeholder="Enter character name">
                                    </div>
                                    <div class="form-group">
                                        <label for="char-desc">Description & Backstory</label>
                                        <textarea id="char-desc" rows="6" placeholder="Describe your character's appearance and history..."></textarea>
                                    </div>
                                </div>

                                <!-- Physical Details -->
                                <div class="review-section physical-section">
                                    <h3>Physical Characteristics</h3>
                                    <div class="physical-grid">
                                        <div class="form-group">
                                            <label for="char-age">Age</label>
                                            <input type="number" id="char-age" placeholder="e.g. 25">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-height">Height</label>
                                            <input type="text" id="char-height" placeholder="e.g. 5'10&quot;">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-weight">Weight</label>
                                            <input type="text" id="char-weight" placeholder="e.g. 180 lb">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="wizard-navigation">
                        <button class="nav-btn prev-btn" disabled>Previous</button>
                        <button class="nav-btn next-btn">Next Step</button>
                    </div>
                </div>

                <!-- Sidebar Summary -->
                <aside class="character-summary">
                    <div class="summary-header">
                        <h3>Character Sheet</h3>
                    </div>
                    <div class="summary-content">
                        <div class="character-image-preview">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="summary-item">
                            <span class="label">Name:</span>
                            <span class="value" id="summary-name">-</span>
                        </div>
                        
                        <div class="summary-item">
                            <span class="label">Race:</span>
                            <span class="value" id="summary-race">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Class:</span>
                            <span class="value" id="summary-class">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Level:</span>
                            <span class="value">1</span>
                        </div>
                        <div class="summary-stats">
                            <div class="mini-stat">
                                <div class="stat-label">STR</div>
                                <div class="stat-val">10</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stat-label">DEX</div>
                                <div class="stat-val">10</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stat-label">CON</div>
                                <div class="stat-val">10</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stat-label">INT</div>
                                <div class="stat-val">10</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stat-label">WIS</div>
                                <div class="stat-val">10</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stat-label">CHA</div>
                                <div class="stat-val">10</div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script type="module" src="../../js/supabase-client.js"></script>
    <script type="module" src="../../js/auth-ui.js"></script>
    <script type="module" src="../../js/create-character-save.js"></script>
    
    <!-- Inline script for basic stepper functionality (placeholder for future character-wizard.js) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const steps = document.querySelectorAll('.wizard-step');
            const panels = document.querySelectorAll('.wizard-panel');
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            let currentStep = 0;

            function updateWizard() {
                // Update Stepper
                steps.forEach((step, index) => {
                    if (index === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else if (index < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                // Update Panels
                panels.forEach((panel, index) => {
                    if (index === currentStep) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });

                // Update Buttons
                prevBtn.disabled = currentStep === 0;
                if (currentStep === steps.length - 1) {
                    nextBtn.textContent = 'Create Character';
                } else {
                    nextBtn.textContent = 'Next Step';
                }
            }

            nextBtn.addEventListener('click', () => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    updateWizard();
                } else {
                    // Submit logic here
                    alert('Character Creation logic to be implemented!');
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateWizard();
                }
            });
            
            // Allow clicking on steps to navigate
            steps.forEach((step, index) => {
                step.addEventListener('click', () => {
                    // Only allow navigating to completed steps or the immediate next one
                    // For now, allow navigation for testing
                    currentStep = index;
                    updateWizard();
                });
            });
        });
    </script>

    <!-- Class Features Panel (ESM) -->
    <script type="module">
        import { renderClassFeaturesPanel, setSelectedLevel, getSelectedLevel } from "../../js/class-features-panel.js";

        function notify(message, type = "success") {
            if (window.HeroVault?.showNotification) {
                window.HeroVault.showNotification(message, type);
                return;
            }
            alert(message);
        }

        function $(sel, root = document) {
            return root.querySelector(sel);
        }

        function getDraftSafe() {
            try {
                const raw = localStorage.getItem("hv_character_draft");
                return raw ? JSON.parse(raw) : {};
            } catch {
                return {};
            }
        }

        function saveDraftSafe(patch) {
            const cur = getDraftSafe();
            const next = { ...cur, ...(patch || {}) };
            try {
                localStorage.setItem("hv_character_draft", JSON.stringify(next));
            } catch {
                // ignore
            }
            window.HVCharacterDraft = { ...(window.HVCharacterDraft || {}), ...next };
            return next;
        }

        function getSummaryLevelValueEl() {
            const summary = document.querySelector(".character-summary");
            if (!summary) return null;
            const items = Array.from(summary.querySelectorAll(".summary-item"));
            for (const it of items) {
                const label = it.querySelector(".label")?.textContent?.trim();
                if (label === "Level:") return it.querySelector(".value");
            }
            return null;
        }

        function setSummaryLevel(level) {
            const el = getSummaryLevelValueEl();
            if (!el) return;
            const n = Number.parseInt(String(level ?? ""), 10);
            el.textContent = Number.isFinite(n) ? String(n) : "1";
        }

        function syncLevelFromSelect() {
            const fromApi = getSelectedLevel?.();
            const fromDom = Number.parseInt(document.getElementById("hvClassLevelSelect")?.value || "1", 10);
            const level = (fromApi ?? (Number.isFinite(fromDom) ? fromDom : 1));
            setSummaryLevel(level);
            saveDraftSafe({ characterLevel: level });
        }

        async function getSession() {
            const { data } = await window.supabase.auth.getSession();
            return data?.session || null;
        }

        async function fetchClasses() {
            const session = await getSession();
            function uniqById(arr) {
                const map = new Map();
                for (const it of arr) {
                    if (!it?.id) continue;
                    map.set(String(it.id), it);
                }
                return Array.from(map.values());
            }

            // 1) Public classes (and own classes when logged in)
            let publicOrOwnedQ = window.supabase
                .from("homebrew")
                .select("id, user_id, type, status, name, data, updated_at")
                .eq("type", "class")
                .order("name", { ascending: true });

            if (session?.user?.id) {
                publicOrOwnedQ = publicOrOwnedQ.or(`status.eq.public,user_id.eq.${session.user.id}`);
            } else {
                publicOrOwnedQ = publicOrOwnedQ.eq("status", "public");
            }

            // 2) Classes saved in user's collection (user_saved_items -> homebrew)
            let savedClasses = [];
            if (session?.user?.id) {
                const { data: savedRows, error: savedErr } = await window.supabase
                    .from("user_saved_items")
                    .select("id, added_at, homebrew:homebrew_id (id, user_id, type, status, name, data, updated_at)")
                    .order("added_at", { ascending: false });
                if (savedErr) throw savedErr;

                savedClasses = (Array.isArray(savedRows) ? savedRows : [])
                    .map((r) => r?.homebrew)
                    .filter((hb) => hb && String(hb.type || "").toLowerCase() === "class");
            }

            const { data: publicOrOwned, error } = await publicOrOwnedQ;
            if (error) throw error;

            const merged = uniqById([...(Array.isArray(publicOrOwned) ? publicOrOwned : []), ...savedClasses]);
            merged.sort((a, b) => String(a?.name || "").localeCompare(String(b?.name || ""), undefined, { sensitivity: "base" }));
            return merged;
        }

        function renderClassCards(gridEl, classes) {
            if (!gridEl) return;
            gridEl.innerHTML = "";

            if (!classes.length) {
                // Keep the panel usable even with empty DB
                gridEl.innerHTML = `
                    <div class="selection-card centered-card">
                        <h3>No classes found</h3>
                    </div>
                `.trim();
                return;
            }

            for (const cls of classes) {
                const card = document.createElement("div");
                card.className = "selection-card centered-card";
                card.dataset.hvClassId = String(cls.id);
                card.innerHTML = `<h3>${cls.name || "Unnamed Class"}</h3>`;
                gridEl.appendChild(card);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const panel = document.getElementById("panel-class");
            if (!panel) return;

            const content = $(".panel-content", panel);
            const grid = $(".selection-grid", panel);
            if (!content || !grid) return;

            // Mount point for the feature panel (below class cards)
            const mountEl = document.createElement("div");
            mountEl.id = "hvClassFeaturesMount";
            content.appendChild(mountEl);

            let classes = [];
            try {
                classes = await fetchClasses();
                renderClassCards(grid, classes);
            } catch (err) {
                console.error("Class load failed:", err);
                notify("Load classes failed", "error");
                // Keep existing placeholder cards if fetch fails
            }

            function clearSelected() {
                grid.querySelectorAll(".selection-card").forEach((c) => c.classList.remove("is-selected"));
            }

            function setSummaryClass(name) {
                const el = document.getElementById("summary-class");
                if (el) el.textContent = name || "-";
            }

            async function onSelectCard(cardEl) {
                const classId = cardEl?.dataset?.hvClassId;
                if (!classId) return;

                clearSelected();
                cardEl.classList.add("is-selected");

                const cls = classes.find((c) => String(c.id) === String(classId)) || null;
                const className = (cls?.name || cardEl.textContent?.trim() || "Class");
                setSummaryClass(className);
                // Persist to draft so create-character-save.js can store `class_id`
                saveDraftSafe({ classId: String(classId), className });

                // If we don't have the row (e.g. placeholders), fetch single.
                let classHomebrew = cls;
                if (!classHomebrew) {
                    const { data, error } = await window.supabase
                        .from("homebrew")
                        .select("id, user_id, type, status, name, data, updated_at")
                        .eq("id", classId)
                        .single();
                    if (error) throw error;
                    classHomebrew = data;
                }

                renderClassFeaturesPanel({ mountEl, classHomebrew });

                // Restore selected level from draft (or default to 1) and sync sidebar.
                const draft = getDraftSafe();
                const desired = Number.parseInt(String(draft.characterLevel ?? "1"), 10);
                setSelectedLevel?.(Number.isFinite(desired) ? desired : 1);
                syncLevelFromSelect();
            }

            // Bind click on current grid cards (works both for fetched cards and placeholders)
            grid.addEventListener("click", (e) => {
                const card = e.target?.closest?.(".selection-card");
                if (!card) return;
                // ignore the "No classes found" placeholder
                if (!card.dataset.hvClassId) return;
                onSelectCard(card).catch((err) => {
                    console.error("Select class failed:", err);
                    notify("Failed to load class features", "error");
                });
            });

            // Auto-select first class if available
            const first = grid.querySelector(".selection-card[data-hv-class-id]");
            if (first) {
                await onSelectCard(first);
            } else {
                // Render empty state
                renderClassFeaturesPanel({ mountEl, classHomebrew: null });
                // still restore sidebar level if present
                const draft = getDraftSafe();
                setSummaryLevel(draft.characterLevel ?? 1);
            }

            // Global listener: whenever level select changes, update Character Sheet sidebar too.
            document.addEventListener("change", (e) => {
                const t = e.target;
                if (t && t.id === "hvClassLevelSelect") {
                    syncLevelFromSelect();
                }
            });

            // Initial restore (before any interactions)
            const draft = getDraftSafe();
            setSummaryLevel(draft.characterLevel ?? 1);
        });
    </script>

    <!-- Race Details Panel (ESM) -->
    <script type="module">
        import { renderRaceDetails, getDraft } from "../../js/race-details-panel.js";

        function notify(message, type = "success") {
            if (window.HeroVault?.showNotification) {
                window.HeroVault.showNotification(message, type);
                return;
            }
            alert(message);
        }

        function $(sel, root = document) {
            return root.querySelector(sel);
        }

        async function getSession() {
            const { data } = await window.supabase.auth.getSession();
            return data?.session || null;
        }

        async function fetchRaces() {
            const session = await getSession();

            function uniqById(arr) {
                const map = new Map();
                for (const it of arr) {
                    if (!it?.id) continue;
                    map.set(String(it.id), it);
                }
                return Array.from(map.values());
            }

            // 1) Public races (and own races when logged in)
            let publicOrOwnedQ = window.supabase
                .from("homebrew")
                .select("id, user_id, type, status, name, data, updated_at")
                .eq("type", "race")
                .order("name", { ascending: true });

            if (session?.user?.id) {
                publicOrOwnedQ = publicOrOwnedQ.or(`status.eq.public,user_id.eq.${session.user.id}`);
            } else {
                publicOrOwnedQ = publicOrOwnedQ.eq("status", "public");
            }

            // 2) Races saved in user's collection
            let savedRaces = [];
            if (session?.user?.id) {
                const { data: savedRows, error: savedErr } = await window.supabase
                    .from("user_saved_items")
                    .select("id, added_at, homebrew:homebrew_id (id, user_id, type, status, name, data, updated_at)")
                    .order("added_at", { ascending: false });
                if (savedErr) throw savedErr;

                savedRaces = (Array.isArray(savedRows) ? savedRows : [])
                    .map((r) => r?.homebrew)
                    .filter((hb) => hb && String(hb.type || "").toLowerCase() === "race");
            }

            const { data: publicOrOwned, error } = await publicOrOwnedQ;
            if (error) throw error;

            const merged = uniqById([...(Array.isArray(publicOrOwned) ? publicOrOwned : []), ...savedRaces]);
            merged.sort((a, b) => String(a?.name || "").localeCompare(String(b?.name || ""), undefined, { sensitivity: "base" }));
            return merged;
        }

        function renderRaceCards(gridEl, races) {
            if (!gridEl) return;
            gridEl.innerHTML = "";

            if (!races.length) {
                gridEl.innerHTML = `
                    <div class="selection-card centered-card">
                        <h3>No races found</h3>
                    </div>
                `.trim();
                return;
            }

            for (const race of races) {
                const card = document.createElement("div");
                card.className = "selection-card";
                card.dataset.hvRaceId = String(race.id);
                card.innerHTML = `
                    <div class="card-content">
                        <h3>${race.name || "Unnamed Race"}</h3>
                    </div>
                `.trim();
                gridEl.appendChild(card);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const panel = document.getElementById("panel-race");
            if (!panel) return;

            const content = $(".panel-content", panel);
            const grid = $(".selection-grid", panel);
            if (!content || !grid) return;

            // Mount point for the race detail panel (below race cards)
            const mountEl = document.createElement("div");
            mountEl.id = "hvRaceDetailsMount";
            content.appendChild(mountEl);

            let races = [];
            try {
                races = await fetchRaces();
                renderRaceCards(grid, races);
            } catch (err) {
                console.error("Race load failed:", err);
                notify("Load races failed", "error");
                // Keep existing placeholder cards if fetch fails
            }

            function clearSelected() {
                grid.querySelectorAll(".selection-card").forEach((c) => c.classList.remove("is-selected"));
            }

            function setSummaryRace(name) {
                const el = document.getElementById("summary-race");
                if (el) el.textContent = name || "-";
            }

            async function onSelectCard(cardEl) {
                const raceId = cardEl?.dataset?.hvRaceId;
                if (!raceId) return;

                clearSelected();
                cardEl.classList.add("is-selected");

                const race = races.find((r) => String(r.id) === String(raceId)) || null;
                setSummaryRace(race?.name || cardEl.textContent?.trim() || "Race");

                // If we don't have the row (e.g. placeholders), fetch single.
                let raceHomebrew = race;
                if (!raceHomebrew) {
                    const { data, error } = await window.supabase
                        .from("homebrew")
                        .select("id, user_id, type, status, name, data, updated_at")
                        .eq("id", raceId)
                        .single();
                    if (error) throw error;
                    raceHomebrew = data;
                }

                renderRaceDetails({ mountEl, raceHomebrew });
            }

            grid.addEventListener("click", (e) => {
                const card = e.target?.closest?.(".selection-card");
                if (!card) return;
                if (!card.dataset.hvRaceId) return;
                onSelectCard(card).catch((err) => {
                    console.error("Select race failed:", err);
                    notify("Failed to load race details", "error");
                });
            });

            // Restore previous draft (race + languages)
            const draft = getDraft();
            const preferredRaceId = draft?.raceId ? String(draft.raceId) : "";
            if (preferredRaceId) {
                const preferred = grid.querySelector(`.selection-card[data-hv-race-id="${CSS.escape(preferredRaceId)}"]`);
                if (preferred) {
                    await onSelectCard(preferred);
                    return;
                }
            }

            // Auto-select first race if available
            const first = grid.querySelector(".selection-card[data-hv-race-id]");
            if (first) {
                await onSelectCard(first);
            } else {
                renderRaceDetails({ mountEl, raceHomebrew: null });
            }
        });
    </script>

    <!-- Background Panel (ESM) -->
    <script type="module">
        import { initBackgroundPanel } from "../../js/background-panel.js";

        function $(sel, root = document) {
            return root.querySelector(sel);
        }

        function notify(message, type = "success") {
            if (window.HeroVault?.showNotification) {
                window.HeroVault.showNotification(message, type);
                return;
            }
            alert(message);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const panel = document.getElementById("panel-background");
            if (!panel) return;

            const content = $(".panel-content", panel);
            if (!content) return;

            // Hide placeholder card grid in this step (we use dropdown UI instead)
            const grid = $(".selection-grid", panel);
            if (grid) grid.style.display = "none";

            const mountEl = document.createElement("div");
            mountEl.id = "hvBackgroundMount";
            content.appendChild(mountEl);

            try {
                await initBackgroundPanel({ mountEl });
            } catch (err) {
                console.error("Background panel failed:", err);
                notify("Load backgrounds failed", "error");
            }
        });
    </script>

    <!-- Equipment Panel (ESM) -->
    <script type="module">
        import { initEquipmentPanel } from "../../js/equipment-panel.js";
        document.addEventListener("DOMContentLoaded", () => {
            initEquipmentPanel().catch((err) => {
                console.error("Equipment panel failed:", err);
            });
        });
    </script>

    <!-- Ability Scores (Manual only) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const methodSelect = document.getElementById("ability-method-select");
            const pointsContainer = document.getElementById("points-container");

            // Manual only: force + lock method selector, hide point-buy UI.
            if (methodSelect) {
                methodSelect.value = "manual";
                Array.from(methodSelect.options || []).forEach((opt) => {
                    opt.disabled = opt.value !== "manual";
                });
            }
            if (pointsContainer) pointsContainer.style.display = "none";

            const ABILITIES = ["str", "dex", "con", "int", "wis", "cha"];

            function toInt(v, fallback = 0) {
                const n = Number.parseInt(String(v ?? ""), 10);
                return Number.isFinite(n) ? n : fallback;
            }

            function modFromScore(score) {
                return Math.floor((score - 10) / 2);
            }

            function fmtMod(n) {
                const sign = n >= 0 ? "+" : "";
                return `${sign}${n}`;
            }

            function parseSignedInt(text) {
                const t = String(text || "").replace(/[^\d+\-]/g, "").trim();
                if (!t) return 0;
                const n = Number.parseInt(t, 10);
                return Number.isFinite(n) ? n : 0;
            }

            function getDetailCards() {
                return Array.from(document.querySelectorAll(".abilities-details-grid .ability-detail-card"));
            }

            function getQuickInput(ability) {
                return document.querySelector(`.base-score-input[data-ability="${ability}"]`);
            }

            function setQuickDisplay(ability, finalScore) {
                const inp = getQuickInput(ability);
                const col = inp?.closest?.(".ability-quick-col");
                if (!col) return;
                const scoreEl = col.querySelector(".total-score");
                const modEl = col.querySelector(".total-mod");
                if (scoreEl) scoreEl.textContent = String(finalScore);
                if (modEl) modEl.textContent = `(${fmtMod(modFromScore(finalScore))})`;
            }

            function setDetailDisplay(cardEl, { baseScore, racialBonus, otherMod, overrideScore, finalScore }) {
                if (!cardEl) return;
                const finalScoreEl = cardEl.querySelector(".final-score");
                const finalModEl = cardEl.querySelector(".final-mod");
                if (finalScoreEl) finalScoreEl.textContent = String(finalScore);
                if (finalModEl) finalModEl.textContent = `(${fmtMod(modFromScore(finalScore))})`;

                // Update "Base Score" row number (2nd span in the row)
                const rows = Array.from(cardEl.querySelectorAll(".detail-row"));
                const baseRow = rows.find((r) => (r.textContent || "").toLowerCase().includes("base score"));
                if (baseRow) {
                    const spans = baseRow.querySelectorAll("span");
                    if (spans[1]) spans[1].textContent = String(baseScore);
                }

                // Update "Racial Bonus" row if present (keep sign)
                const racialRow = rows.find((r) => (r.textContent || "").toLowerCase().includes("racial bonus"));
                if (racialRow) {
                    const spans = racialRow.querySelectorAll("span");
                    if (spans[1]) spans[1].textContent = `${racialBonus >= 0 ? "+" : ""}${racialBonus}`;
                }

                // Other mod + override inputs: keep user's values (we only read them)
                // No-op here on purpose.
            }

            function recalcAll() {
                const cards = getDetailCards();
                const finalScores = {};
                const modifiers = {};

                ABILITIES.forEach((ability, idx) => {
                    const baseInput = getQuickInput(ability);
                    const baseScore = toInt(baseInput?.value, 0);

                    const card = cards[idx] || null;
                    const racialBonus = parseSignedInt(card?.querySelectorAll(".detail-row")[1]?.querySelectorAll("span")[1]?.textContent);
                    const otherMod = toInt(card?.querySelector('input.mini-input:not(.override-input)')?.value, 0);
                    const overrideRaw = card?.querySelector("input.override-input")?.value;
                    const overrideScore = overrideRaw != null && String(overrideRaw).trim() !== "" ? toInt(overrideRaw, baseScore) : null;

                    const computed = baseScore + racialBonus + otherMod;
                    const finalScore = overrideScore != null ? overrideScore : computed;

                    finalScores[ability] = finalScore;
                    modifiers[ability] = modFromScore(finalScore);

                    setQuickDisplay(ability, finalScore);
                    setDetailDisplay(card, { baseScore, racialBonus, otherMod, overrideScore, finalScore });
                });

                // Update Character Sheet sidebar mini-stats
                try {
                    const summary = document.querySelector(".character-summary");
                    if (summary) {
                        summary.querySelectorAll(".mini-stat").forEach((mini) => {
                            const label = mini.querySelector(".stat-label")?.textContent?.trim()?.toLowerCase();
                            const valEl = mini.querySelector(".stat-val");
                            if (!label || !valEl) return;

                            const key = label === "str" ? "str"
                                : label === "dex" ? "dex"
                                : label === "con" ? "con"
                                : label === "int" ? "int"
                                : label === "wis" ? "wis"
                                : label === "cha" ? "cha"
                                : null;

                            if (!key) return;
                            const v = finalScores[key];
                            valEl.textContent = v == null ? "-" : String(v);
                        });
                    }
                } catch (e) {
                    // ignore summary UI errors
                }

                // Persist to draft
                try {
                    const raw = localStorage.getItem("hv_character_draft");
                    const draft = raw ? JSON.parse(raw) : {};
                    draft.abilityMethod = "manual";
                    draft.abilityFinalScores = finalScores;
                    draft.abilityModifiers = modifiers;
                    localStorage.setItem("hv_character_draft", JSON.stringify(draft));
                    window.HVCharacterDraft = { ...(window.HVCharacterDraft || {}), ...draft };
                } catch (e) {
                    console.warn("Failed to persist ability draft:", e);
                }
            }

            // Bind listeners
            document.querySelectorAll("input.base-score-input[data-ability]").forEach((inp) => {
                inp.addEventListener("input", recalcAll);
                inp.addEventListener("change", recalcAll);
            });
            document.querySelectorAll(".abilities-details-grid input.mini-input").forEach((inp) => {
                inp.addEventListener("input", recalcAll);
                inp.addEventListener("change", recalcAll);
            });

            // Initial calculate
            recalcAll();
        });
    </script>
</body>
</html>
